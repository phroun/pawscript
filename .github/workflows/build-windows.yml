name: Build Windows

# Only run on branches starting with 'w64' to avoid wasting CI minutes
on:
  push:
    branches:
      - 'w64*'
      - 'w64-*'
      - 'w64/**'
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  build-windows-gtk:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gtk3
            mingw-w64-x86_64-go
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-librsvg
            mingw-w64-x86_64-adwaita-icon-theme
            git

      - name: Build pawgui-gtk
        run: |
          cd src
          export CGO_ENABLED=1
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:$PKG_CONFIG_PATH"
          go build -ldflags="-H windowsgui -s -w" -o ../pawgui-gtk-windows-amd64.exe ./cmd/pawgui-gtk/

      - name: Build paw CLI
        run: |
          cd src
          go build -ldflags="-s -w" -o ../paw-windows-amd64.exe ./cmd/paw/

      - name: Collect GTK DLLs
        run: |
          set -x  # Debug: show commands as they run

          mkdir -p dist/windows

          # Verify builds exist
          ls -la *.exe

          cp pawgui-gtk-windows-amd64.exe dist/windows/
          cp paw-windows-amd64.exe dist/windows/

          # Copy required GTK DLLs to same folder as exe (Windows loads DLLs before any code runs)
          # Use a file as a queue to process DLLs iteratively
          echo "pawgui-gtk-windows-amd64.exe" > /tmp/dll_queue.txt
          touch /tmp/dll_done.txt

          while [ -s /tmp/dll_queue.txt ]; do
            # Get first item from queue
            current=$(head -1 /tmp/dll_queue.txt)
            tail -n +2 /tmp/dll_queue.txt > /tmp/dll_queue_tmp.txt
            mv /tmp/dll_queue_tmp.txt /tmp/dll_queue.txt

            # Skip if already processed
            if grep -qxF "$current" /tmp/dll_done.txt 2>/dev/null; then
              continue
            fi
            echo "$current" >> /tmp/dll_done.txt

            # Get dependencies
            ldd "$current" 2>/dev/null | grep mingw64 | awk '{print $3}' > /tmp/deps.txt || true
            while IFS= read -r dll; do
              if [ -f "$dll" ] && [ ! -f "dist/windows/$(basename "$dll")" ]; then
                cp "$dll" dist/windows/
                echo "$dll" >> /tmp/dll_queue.txt
              fi
            done < /tmp/deps.txt
          done

          echo "Copied $(ls dist/windows/*.dll 2>/dev/null | wc -l) DLLs"

          # Copy GDK-Pixbuf loaders and their dependencies
          mkdir -p dist/windows/lib/gdk-pixbuf-2.0/2.10.0/loaders
          if ls /mingw64/lib/gdk-pixbuf-2.0/2.10.0/loaders/*.dll 1>/dev/null 2>&1; then
            for loader in /mingw64/lib/gdk-pixbuf-2.0/2.10.0/loaders/*.dll; do
              cp "$loader" dist/windows/lib/gdk-pixbuf-2.0/2.10.0/loaders/
              # Copy loader dependencies (including librsvg deps for SVG icons)
              ldd "$loader" 2>/dev/null | grep mingw64 | awk '{print $3}' > /tmp/loader_deps.txt || true
              while IFS= read -r dll; do
                if [ -f "$dll" ] && [ ! -f "dist/windows/$(basename "$dll")" ]; then
                  cp "$dll" dist/windows/
                fi
              done < /tmp/loader_deps.txt
            done
          fi

          # Generate loaders.cache with correct relative paths for Windows
          # The cache file from MSYS2 has /mingw64 paths which won't work on Windows
          cd dist/windows
          GDK_PIXBUF_MODULEDIR=lib/gdk-pixbuf-2.0/2.10.0/loaders \
            gdk-pixbuf-query-loaders.exe lib/gdk-pixbuf-2.0/2.10.0/loaders/*.dll \
            > lib/gdk-pixbuf-2.0/2.10.0/loaders.cache 2>/dev/null || \
            cp /mingw64/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache lib/gdk-pixbuf-2.0/2.10.0/ 2>/dev/null || true
          cd ../..

          echo "=== Pixbuf loaders ==="
          cat dist/windows/lib/gdk-pixbuf-2.0/2.10.0/loaders.cache 2>/dev/null | head -30 || echo "No loaders.cache"

          # Copy GTK schemas
          mkdir -p dist/windows/share/glib-2.0/schemas
          cp /mingw64/share/glib-2.0/schemas/gschemas.compiled dist/windows/share/glib-2.0/schemas/ 2>/dev/null || true

          # Copy icons (optional - we use emoji fallbacks anyway)
          mkdir -p dist/windows/share/icons/Adwaita
          cp -r /mingw64/share/icons/Adwaita/16x16 dist/windows/share/icons/Adwaita/ 2>/dev/null || true
          cp -r /mingw64/share/icons/Adwaita/22x22 dist/windows/share/icons/Adwaita/ 2>/dev/null || true
          cp -r /mingw64/share/icons/Adwaita/24x24 dist/windows/share/icons/Adwaita/ 2>/dev/null || true
          cp -r /mingw64/share/icons/Adwaita/32x32 dist/windows/share/icons/Adwaita/ 2>/dev/null || true
          cp -r /mingw64/share/icons/Adwaita/index.theme dist/windows/share/icons/Adwaita/ 2>/dev/null || true
          cp -r /mingw64/share/icons/hicolor dist/windows/share/icons/ 2>/dev/null || true

          # Copy examples
          cp -r examples dist/windows/

          echo "=== Final distribution contents ==="
          find dist/windows -type f | head -50
          echo "Total files: $(find dist/windows -type f | wc -l)"

      - name: Upload Windows GTK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pawscript-gtk-windows-amd64
          path: dist/windows/
          retention-days: 30

  build-windows-qt:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-qt5-base
            mingw-w64-x86_64-go
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-gcc
            git

      - name: Build pawgui-qt
        run: |
          cd src
          export CGO_ENABLED=1
          export PKG_CONFIG_PATH="/mingw64/lib/pkgconfig:$PKG_CONFIG_PATH"
          go build -ldflags="-H windowsgui -s -w" -o ../pawgui-qt-windows-amd64.exe ./cmd/pawgui-qt/

      - name: Build paw CLI
        run: |
          cd src
          go build -ldflags="-s -w" -o ../paw-windows-amd64.exe ./cmd/paw/

      - name: Collect Qt DLLs
        run: |
          set -x  # Debug: show commands as they run

          mkdir -p dist/windows-qt

          # Verify builds exist
          ls -la *.exe

          cp pawgui-qt-windows-amd64.exe dist/windows-qt/
          cp paw-windows-amd64.exe dist/windows-qt/

          # Copy required Qt DLLs to same folder as exe (Windows loads DLLs before any code runs)
          # Use a file as a queue to process DLLs iteratively
          echo "pawgui-qt-windows-amd64.exe" > /tmp/dll_queue.txt
          touch /tmp/dll_done.txt

          while [ -s /tmp/dll_queue.txt ]; do
            # Get first item from queue
            current=$(head -1 /tmp/dll_queue.txt)
            tail -n +2 /tmp/dll_queue.txt > /tmp/dll_queue_tmp.txt
            mv /tmp/dll_queue_tmp.txt /tmp/dll_queue.txt

            # Skip if already processed
            if grep -qxF "$current" /tmp/dll_done.txt 2>/dev/null; then
              continue
            fi
            echo "$current" >> /tmp/dll_done.txt

            # Get dependencies
            ldd "$current" 2>/dev/null | grep mingw64 | awk '{print $3}' > /tmp/deps.txt || true
            while IFS= read -r dll; do
              if [ -f "$dll" ] && [ ! -f "dist/windows-qt/$(basename "$dll")" ]; then
                cp "$dll" dist/windows-qt/
                echo "$dll" >> /tmp/dll_queue.txt
              fi
            done < /tmp/deps.txt
          done

          echo "Copied $(ls dist/windows-qt/*.dll 2>/dev/null | wc -l) DLLs"

          # Copy Qt platform plugins (required for Qt apps to run on Windows)
          mkdir -p dist/windows-qt/plugins/platforms
          cp /mingw64/share/qt5/plugins/platforms/qwindows.dll dist/windows-qt/plugins/platforms/ 2>/dev/null || true

          # Copy Qt style plugins for native look
          mkdir -p dist/windows-qt/plugins/styles
          cp /mingw64/share/qt5/plugins/styles/*.dll dist/windows-qt/plugins/styles/ 2>/dev/null || true

          # Copy Qt imageformats plugins
          mkdir -p dist/windows-qt/plugins/imageformats
          cp /mingw64/share/qt5/plugins/imageformats/*.dll dist/windows-qt/plugins/imageformats/ 2>/dev/null || true

          # Create qt.conf to tell Qt where to find plugins
          cat > dist/windows-qt/qt.conf << 'EOF'
          [Paths]
          Plugins = plugins
          EOF

          # Copy examples
          cp -r examples dist/windows-qt/

          echo "=== Final distribution contents ==="
          find dist/windows-qt -type f | head -50
          echo "Total files: $(find dist/windows-qt -type f | wc -l)"

      - name: Upload Windows Qt artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pawscript-qt-windows-amd64
          path: dist/windows-qt/
          retention-days: 30

  build-cli-crossplatform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: src/go.sum

      - name: Build CLI for multiple platforms
        run: |
          cd src
          mkdir -p ../dist

          # Windows AMD64
          GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../dist/paw-windows-amd64.exe ./cmd/paw/

          # Windows ARM64
          GOOS=windows GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../dist/paw-windows-arm64.exe ./cmd/paw/

          # Linux AMD64
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../dist/paw-linux-amd64 ./cmd/paw/

          # Linux ARM64
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../dist/paw-linux-arm64 ./cmd/paw/

          # macOS AMD64
          GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../dist/paw-darwin-amd64 ./cmd/paw/

          # macOS ARM64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 go build -ldflags="-s -w" -o ../dist/paw-darwin-arm64 ./cmd/paw/

      - name: Upload CLI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: paw-cli-all-platforms
          path: dist/
          retention-days: 30
