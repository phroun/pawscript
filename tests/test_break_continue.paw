#!/usr/bin/env paw
# Test break and continue commands in loops
# BUG: break/continue inside blocks executed via & operator don't propagate correctly

echo "=== Test 1: break in while loop with if ==="
i: 0
while (lt ~i, 10), (
    i: {add ~i, 1}
    if {eq ~i, 5} then (
        echo "Breaking at i=~i"
        break
    )
    echo "i = ~i"
)
echo "After while: i = ~i"

echo ""
echo "=== Test 2: continue in while loop ==="
i: 0
while (lt ~i, 8), (
    i: {add ~i, 1}
    if {eq ~i, 3} then (
        echo "Skipping i=~i"
        continue
    )
    if {eq ~i, 6} then (
        echo "Skipping i=~i"
        continue
    )
    echo "Processing i = ~i"
)

echo ""
echo "=== Test 3: break in for loop (numeric range) ==="
for 1, 10, n, (
    if {eq ~n, 4} then (
        echo "Breaking at n=~n"
        break
    )
    echo "n = ~n"
)

echo ""
echo "=== Test 4: continue in for loop (numeric range) ==="
for 1, 8, n, (
    if {eq ~n, 2} then (
        echo "Skipping n=~n"
        continue
    )
    if {eq ~n, 5} then (
        echo "Skipping n=~n"
        continue
    )
    echo "Processing n = ~n"
)

echo ""
echo "=== Test 5: break in for loop (list iteration) ==="
items: (apple, banana, cherry, date, elderberry)
for ~items, item, (
    if {eq ~item, cherry} then (
        echo "Breaking at ~item"
        break
    )
    echo "Item: ~item"
)

echo ""
echo "=== Test 6: continue in for loop (list iteration) ==="
for ~items, item, (
    if {eq ~item, banana} then (
        echo "Skipping ~item"
        continue
    )
    if {eq ~item, date} then (
        echo "Skipping ~item"
        continue
    )
    echo "Processing: ~item"
)

echo ""
echo "=== Test 7: break with level (nested loops) ==="
for 1, 3, outer, (
    echo "Outer: ~outer"
    for 1, 3, inner, (
        echo "  Inner: ~inner"
        if {eq ~inner, 2} then (
            if {eq ~outer, 2} then (
                echo "  Breaking both loops!"
                break 2
            )
        )
    )
)
echo "After nested loops"

echo ""
echo "=== Test 8: continue with level (nested loops) ==="
for 1, 3, outer, (
    echo "Outer: ~outer"
    for 1, 3, inner, (
        if {eq ~inner, 2} then (
            if {eq ~outer, 2} then (
                echo "  Continuing outer loop from inner"
                continue 2
            )
        )
        echo "  Inner: ~inner"
    )
    echo "  End of outer iteration ~outer"
)

echo ""
echo "=== Test 9: break in while with true condition ==="
count: 0
while (true), (
    count: {add ~count, 1}
    echo "Count: ~count"
    if {gte ~count, 3} then (
        break
    )
)
echo "Final count: ~count"

echo ""
echo "=== Test 10: break via & operator ==="
for 1, 5, x, (
    echo "x = ~x"
    {eq ~x, 3} & break
)
echo "Should have stopped at x=3"

echo ""
echo "=== Test 11: continue via & operator ==="
for 1, 5, x, (
    {eq ~x, 2} & continue
    {eq ~x, 4} & continue
    echo "Processing x = ~x"
)
echo "Should have skipped x=2 and x=4"

echo ""
echo "=== All break/continue tests complete ==="
