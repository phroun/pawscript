#!/usr/bin/env paw
# Comprehensive test for get_type command
# Tests type detection for variables containing all 9 types

echo "=== get_type Comprehensive Test ==="
echo ""

# Test 1: Integer variables
echo "Test 1: Integer variables"
set int1, 42
get_type int1
echo "  int1 = 42 → {get_result} (expected: int)"

set int2, -10
get_type int2
echo "  int2 = -10 → {get_result} (expected: int)"

set int3, 0
get_type int3
echo "  int3 = 0 → {get_result} (expected: int)"
echo ""

# Test 2: Float variables
echo "Test 2: Float variables"
set float1, 3.14
get_type float1
echo "  float1 = 3.14 → {get_result} (expected: float)"

set float2, -0.5
get_type float2
echo "  float2 = -0.5 → {get_result} (expected: float)"

set float3, 0.0
get_type float3
echo "  float3 = 0.0 → {get_result} (expected: float)"
echo ""

# Test 3: Boolean variables
echo "Test 3: Boolean variables"
set bool1, true
get_type bool1
echo "  bool1 = true → {get_result} (expected: bool)"

set bool2, false
get_type bool2
echo "  bool2 = false → {get_result} (expected: bool)"
echo ""

# Test 4: nil variables
echo "Test 4: nil variables"
set null_var, nil
get_type null_var
echo "  null_var = nil → {get_result} (expected: nil)"
echo ""

# Test 5: String variables (quoted)
echo "Test 5: String variables (quoted)"
set str1, "hello"
get_type str1
echo "  str1 = \"hello\" → {get_result} (expected: string)"

set str2, "world"
get_type str2
echo "  str2 = \"world\" → {get_result} (expected: string)"

set str3, ""
get_type str3
echo "  str3 = \"\" (empty) → {get_result} (expected: string)"

set str4, "42"
get_type str4
echo "  str4 = \"42\" → {get_result} (expected: string)"
echo ""

# Test 6: Symbol variables (bare identifiers)
echo "Test 6: Symbol variables (bare identifiers)"
set sym1, myvar
get_type sym1
echo "  sym1 = myvar → {get_result} (expected: symbol)"

set sym2, identifier
get_type sym2
echo "  sym2 = identifier → {get_result} (expected: symbol)"

set sym3, foo123
get_type sym3
echo "  sym3 = foo123 → {get_result} (expected: symbol)"

set sym4, _underscore
get_type sym4
echo "  sym4 = _underscore → {get_result} (expected: symbol)"
echo ""

# Test 7: Block variables (ParenGroup)
echo "Test 7: Block variables (ParenGroup)"
set block1, (echo test)
get_type block1
echo "  block1 = (echo test) → {get_result} (expected: block)"

set block2, (code here)
get_type block2
echo "  block2 = (code here) → {get_result} (expected: block)"

set block3, ()
get_type block3
echo "  block3 = () → {get_result} (expected: block)"
echo ""

# Test 8: Undefined variables
echo "Test 8: Undefined variables"
get_type nonexistent_var1
echo "  nonexistent_var1 → {get_result} (expected: undefined)"

get_type never_defined
echo "  never_defined → {get_result} (expected: undefined)"

get_type xyz123
echo "  xyz123 → {get_result} (expected: undefined)"
echo ""

# Test 9: Symbol vs String variables
echo "Test 9: Symbol vs String variables"
set role_sym, admin
get_type role_sym
echo "  role_sym = admin → {get_result} (expected: symbol)"

set role_str, "admin"
get_type role_str
echo "  role_str = \"admin\" → {get_result} (expected: string)"

set status_sym, active
get_type status_sym
echo "  status_sym = active → {get_result} (expected: symbol)"

set status_str, "active"
get_type status_str
echo "  status_str = \"active\" → {get_result} (expected: string)"
echo ""

# Test 10: Variable overwriting with different types
echo "Test 10: Variable type changes"
set x, 42
get_type x
echo "  x = 42 → {get_result} (expected: int)"

set x, "hello"
get_type x
echo "  x = \"hello\" → {get_result} (expected: string)"

set x, myidentifier
get_type x
echo "  x = myidentifier → {get_result} (expected: symbol)"

set x, true
get_type x
echo "  x = true → {get_result} (expected: bool)"

set x, (code)
get_type x
echo "  x = (code) → {get_result} (expected: block)"
echo ""

# Test 11: Numbers in different forms
echo "Test 11: Numbers in different forms"
set num_int, 123
get_type num_int
echo "  num_int = 123 → {get_result} (expected: int)"

set num_str, "123"
get_type num_str
echo "  num_str = \"123\" → {get_result} (expected: string)"

set num_float, 123.0
get_type num_float
echo "  num_float = 123.0 → {get_result} (expected: float)"
echo ""

# Test 12: Special string values
echo "Test 12: Special string values"
set special1, "false"
get_type special1
echo "  special1 = \"false\" → {get_result} (expected: string)"

set special2, "0"
get_type special2
echo "  special2 = \"0\" → {get_result} (expected: string)"

set special3, "nil"
get_type special3
echo "  special3 = \"nil\" → {get_result} (expected: string)"

set special4, "true"
get_type special4
echo "  special4 = \"true\" → {get_result} (expected: string)"
echo ""

# Test 13: Variable existence checking
echo "Test 13: Variable existence checking"

set exists_var, test
if {eq {get_type exists_var}, undefined} then (
    echo "  ✗ FAIL: exists_var should exist"
) else (
    echo "  ✓ PASS: exists_var exists (type: {get_type exists_var})"
)

if {eq {get_type does_not_exist}, undefined} then (
    echo "  ✓ PASS: does_not_exist is undefined"
) else (
    echo "  ✗ FAIL: does_not_exist should be undefined"
)
echo ""

# Test 14: Case sensitivity
echo "Test 14: Case sensitivity"
set MyVar, test1
set myvar, test2
set MYVAR, test3

get_type MyVar
echo "  MyVar → {get_result} (expected: symbol)"

get_type myvar
echo "  myvar → {get_result} (expected: symbol)"

get_type MYVAR
echo "  MYVAR → {get_result} (expected: symbol)"

get_type myVAR
echo "  myVAR (not defined) → {get_result} (expected: undefined)"
echo ""

#(
# Test 15: Practical use cases
echo "Test 15: Practical use cases"

# Safe variable access pattern
macro safe_access(
    if {eq {get_type $1}, undefined} then (
        echo "Variable $1 is not defined, using default"
        set_result "default"
    ) else (
        echo "Variable $1 exists with type: {get_type $1}"
        get $1
    )
)

echo "  Testing safe_access macro:"
echo "    Result for undefined_var: {safe_access undefined_var}"

set my_value, actual
echo "    Result for my_value: {safe_access my_value}"
echo ""

# Type-based dispatch
macro type_dispatch(
    if {eq {get_type $1}, symbol} then (
        echo "Got symbol: {get $1}"
    ) else if {eq {get_type $1}, string} then (
        echo "Got string: {get $1}"
    ) else if {eq {get_type $1}, int} then (
        echo "Got int: {get $1}"
    ) else if {eq {get_type $1}, undefined} then (
        echo "Variable $1 is undefined"
    ) else (
        echo "Got {get_type $1}: {get $1}"
    )
)

set test_sym, identifier
set test_str, "text"
set test_int, 42

echo "  Testing type_dispatch macro:"
echo "    "
type_dispatch test_sym
echo "    "
type_dispatch test_str
echo "    "
type_dispatch test_int
echo "    "
type_dispatch not_defined
echo ""
)#

echo "=== Summary ==="
echo ""
echo "Expected behaviors:"
echo "  - Variables store their original type"
echo "  - Bare identifiers → symbol"
echo "  - Quoted text → string"
echo "  - Undefined variables → undefined"
echo "  - get_type always returns a type name (never fails)"
echo ""
echo "If all results match expected, get_type is working correctly!"
echo ""
echo "=== Test Complete ==="
