#!/usr/bin/env paw
# Comprehensive test for immutable PawList type

echo "=== PawList Tests ==="
echo ""

# Test 1: Creating lists
echo "Test 1: Creating lists"
empty: {list}
fruits: {list apple, banana, cherry}
nums: {list 1, 2, 3, 4, 5}
mixed: {list 42, "text", true, nil}

echo "Empty list created"
echo "Fruits list created"
echo "Numbers list created"
echo "Mixed list created"
echo ""

# Test 2: Type detection
echo "Test 2: Type detection"
echo "Type of fruits: {type fruits}"
echo "Type of nums: {type nums}"
echo "Type of empty: {type empty}"
echo "(Expected: list for all)"
echo ""

# Test 3: List length
echo "Test 3: List length (len command)"
echo "Length of empty: {len ~empty}"
echo "Length of fruits: {len ~fruits}"
echo "Length of nums: {len ~nums}"
echo "(Expected: 0, 3, 5)"
echo ""

# Test 4: argc with lists
echo "Test 4: argc with PawList"
echo "argc of fruits: {argc ~fruits}"
echo "argc of nums: {argc ~nums}"
echo "argc of empty: {argc ~empty}"
echo "(Expected: 3, 5, 0)"
echo ""

# Test 5: argv with lists
echo "Test 5: argv with PawList (1-indexed)"
echo "First fruit: {argv ~fruits, 1}"
echo "Second fruit: {argv ~fruits, 2}"
echo "Third fruit: {argv ~fruits, 3}"
echo "(Expected: apple, banana, cherry)"
echo ""

# Test 6: Slicing (end exclusive)
echo "Test 6: Slicing lists"
slice1: {slice ~fruits, 0, 2}
echo "Slice [0:2] of fruits: {argv ~slice1, 1}, {argv ~slice1, 2}"

slice2: {slice ~nums, 1, 4}
echo "Slice [1:4] of nums: {argv ~slice2, 1}, {argv ~slice2, 2}, {argv ~slice2, 3}"

slice3: {slice ~nums, 2, -1}
echo "Slice [2:end] of nums: {len ~slice3} items"
echo "(Expected: apple,banana | 2,3,4 | 3 items)"
echo ""

# Test 7: Appending (immutable - returns new list)
echo "Test 7: Appending to lists (immutable)"
original: {list a, b, c}
echo "Original length: {len ~original}"

appended: {append ~original, d}
echo "After append, new list length: {len ~appended}"
echo "Original list length still: {len ~original}"
echo "Appended list items: {argv ~appended, 1}, {argv ~appended, 2}, {argv ~appended, 3}, {argv ~appended, 4}"
echo "(Expected: 3, 4, 3, a,b,c,d)"
echo ""

# Test 8: Prepending
echo "Test 8: Prepending to lists"
prepended: {prepend ~original, z}
echo "Prepended list items: {argv ~prepended, 1}, {argv ~prepended, 2}, {argv ~prepended, 3}, {argv ~prepended, 4}"
echo "(Expected: z,a,b,c)"
echo ""

# Test 9: Concatenating lists
echo "Test 9: Concatenating lists"
list1: {list 1, 2, 3}
list2: {list 4, 5, 6}
combined: {concat ~list1, ~list2}
echo "Combined length: {len ~combined}"
echo "Combined items: {argv ~combined, 1}, {argv ~combined, 2}, {argv ~combined, 3}, {argv ~combined, 4}, {argv ~combined, 5}, {argv ~combined, 6}"
echo "(Expected: 6, 1,2,3,4,5,6)"
echo ""

# Test 10: Functional style - building up lists
echo "Test 10: Functional style (rebinding)"
mylist: {list}
echo "Starting with empty list: {len ~mylist} items"

mylist: {append ~mylist, first}
echo "After append first: {len ~mylist} items"

mylist: {append ~mylist, second}
echo "After append second: {len ~mylist} items"

mylist: {append ~mylist, third}
echo "After append third: {len ~mylist} items"

echo "Final list: {argv ~mylist, 1}, {argv ~mylist, 2}, {argv ~mylist, 3}"
echo "(Expected: 0, 1, 2, 3, first,second,third)"
echo ""

# Test 11: List from ParenGroup
echo "Test 11: Creating list from ParenGroup"
fromParen: {list red, green, blue}
echo "List from paren length: {len ~fromParen}"
echo "Items: {argv ~fromParen, 1}, {argv ~fromParen, 2}, {argv ~fromParen, 3}"
echo "(Expected: 3, red,green,blue)"
echo ""

# Test 12: Slicing shares backing array (memory efficient)
echo "Test 12: Memory efficiency - slicing"
large: {list 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}
small1: {slice ~large, 0, 3}
small2: {slice ~large, 3, 6}
small3: {slice ~large, 6, 10}

echo "Large list: {len ~large} items"
echo "Small slices: {len ~small1}, {len ~small2}, {len ~small3} items"
echo "(All slices share backing array!)"
echo "(Expected: 10, 3,3,4)"
echo ""

# Test 13: Compact to free backing array
echo "Test 13: Compact operation"
huge: {list 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15}
tiny: {slice ~huge, 0, 2}
freed: {compact ~tiny}

echo "Tiny slice length: {len ~tiny}"
echo "Compacted length: {len ~freed}"
echo "Items same: {argv ~freed, 1}, {argv ~freed, 2}"
echo "(Expected: 2, 2, 1,2)"
echo ""

# Test 14: String slicing
echo "Test 14: String slicing (works too!)"
text: "hello world"
sub1: {slice ~text, 0, 5}
sub2: {slice ~text, 6, -1}

echo "Original: ~text"
echo "Slice [0:5]: ~sub1"
echo "Slice [6:end]: ~sub2"
echo "(Expected: hello world, hello, world)"
echo ""

# Test 15: String length
echo "Test 15: String length"
echo "Length of 'hello': {len "hello"}"
echo "Length of empty string: {len ""}"
echo "(Expected: 5, 0)"
echo ""

# Test 16: Nested list operations
echo "Test 16: Nested operations"
base: {list 1, 2, 3}
result: {append {slice ~base, 0, 2}, 99}
echo "Result length: {len ~result}"
echo "Result items: {argv ~result, 1}, {argv ~result, 2}, {argv ~result, 3}"
echo "(Expected: 3, 1,2,99)"
echo ""

# Test 17: Lists with variables
echo "Test 17: Lists containing variables"
x: 10
y: 20
z: 30
coords: {list ~x, ~y, ~z}
echo "Coordinates: {argv ~coords, 1}, {argv ~coords, 2}, {argv ~coords, 3}"
echo "(Expected: 10,20,30)"
echo ""

# Test 18: Type preservation in lists
echo "Test 18: Type preservation"
typedList: {list 42, "text", true, symbol, nil}
echo "Item 1 type: {infer {argv ~typedList, 1}}"
echo "Item 2 type: {infer {argv ~typedList, 2}}"
echo "Item 3 type: {infer {argv ~typedList, 3}}"
echo "Item 4 type: {infer {argv ~typedList, 4}}"
echo "Item 5 type: {infer {argv ~typedList, 5}}"
echo "(Expected: int, string, bool, symbol, nil)"
echo ""

echo "=== All List Tests Complete ==="
