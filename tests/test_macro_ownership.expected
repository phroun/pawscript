=== Macro Result Ownership Transfer Test ===

Test 1: Initial state
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 184 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
Expected: 0 objects

Test 2: Macro that returns a list
After calling macro that returns list:
=== Memory Statistics ===
Total stored objects: 7
Total estimated size: 271 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
8     list      1         87
Expected: 1 list with refcount=1 (owned by parent's result)

Test 3: Clear result
After clearing result:
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 184 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
Expected: 0 lists (should be freed)

Test 4: Macro that returns nested list
After calling macro that returns nested list:
=== Memory Statistics ===
Total stored objects: 8
Total estimated size: 317 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
10    list      1         51
11    list      1         82
Expected: 2 lists (inner and outer, both owned by parent's result)

Test 5: Clear result again
After clearing result:
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 184 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
Expected: 0 lists (both freed via cascade cleanup)

Test 6: Macro called from another macro
Inner macro returned, result is: (inner_result)
After nested macro calls:
=== Memory Statistics ===
Total stored objects: 8
Total estimated size: 322 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
14    list      1         52
15    list      1         86
Expected: 2 lists (inner from inner_macro, outer containing reference to inner)

Test 7: Clear final result
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 184 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
Expected: 0 lists

Test 8: Loop creating many lists via macro
After creating and clearing 10 lists via macro:
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 184 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     token     0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     channel   0         32
Expected: 0 lists (no leaks from repeated macro calls)

=== Test Complete ===
