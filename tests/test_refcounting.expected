=== Reference Counting Test ===

Test 1: Single list reference
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 227 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     list      2         75
Expected: 1 list with refcount=2 (list1 + result from assignment)

Test 2: Multiple variables referencing same list
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 227 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     list      3         75
Expected: 1 list with refcount=3 (list1 + list2 + result)

Test 3: Clear one reference with nil (also clears result)
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 227 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
6     list      1         75
Expected: 1 list with refcount=1 (only list2; nil assignment cleared result)

Test 4: Clear last reference
=== Memory Statistics ===
Total stored objects: 5
Total estimated size: 152 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
Expected: 0 lists (freed when last reference cleared)

Test 5: Large string with multiple references
=== Memory Statistics ===
Total stored objects: 7
Total estimated size: 744 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
7     string    1         296
8     string    1         296
Expected: 1 string with refcount=2 (str1 + result)

Test 6: Copy string reference to another variable
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 448 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
7     string    3         296
Expected: 1 string with refcount=3 (str1 + str2 + result)

Test 7: Copy to third variable
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 448 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
7     string    4         296
Expected: 1 string with refcount=4 (str1 + str2 + str3 + result)

Test 8: Clear middle reference
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 448 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
7     string    2         296
Expected: 1 string with refcount=2 (str1 + str3; result now holds nil)

Test 9: Clear remaining references
=== Memory Statistics ===
Total stored objects: 5
Total estimated size: 152 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
Expected: 0 objects (string freed)

Test 10: Large block with multiple references
=== Memory Statistics ===
Total stored objects: 7
Total estimated size: 1296 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
9     block     1         572
10    block     1         572
Expected: 1 block with refcount=2 (block1 + result)

Test 11: Share block across variables
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 724 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
9     block     4         572
Expected: 1 block with refcount=4 (block1 + block2 + block3 + result)

Test 12: Clear all block references
=== Memory Statistics ===
Total stored objects: 5
Total estimated size: 152 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
Expected: 0 objects (block freed)

Test 13: Nested list with shared inner list
=== Memory Statistics ===
Total stored objects: 8
Total estimated size: 373 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
11    list      3         75
12    list      1         73
13    list      2         73
Expected: 3 lists - inner (refcount=3), outer1 (refcount=1), outer2 (refcount=2 with result)

Test 14: Clear outer lists but keep inner
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 227 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
11    list      1         75
Expected: 1 list (inner) with refcount=1

Test 15: Clear inner list
=== Memory Statistics ===
Total stored objects: 5
Total estimated size: 152 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
Expected: 0 lists

Test 16: List in result with refcount
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 196 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
14    list      2         44
Expected: 1 list with refcount=2 (mylist variable + result)

Test 17: Clear variable with nil (clears both variable and result)
=== Memory Statistics ===
Total stored objects: 5
Total estimated size: 152 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
Expected: 0 lists (nil assignment also sets result to nil)

Test 18: Demonstrate undefined preserves result
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 201 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
15    list      2         49
Expected: 1 list with refcount=2 (mylist2 + result)

Test 19: Delete variable with undefined (preserves result)
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 201 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
15    list      1         49
Expected: 1 list with refcount=1 (only result; undefined leaves result intact)

Test 20: Clear result after undefined
=== Memory Statistics ===
Total stored objects: 5
Total estimated size: 152 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
Expected: 0 lists (result cleared, list freed)

Test 21: Compare nil vs undefined - nil clears result
Before nil assignment:
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 203 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
16    list      2         51
After nil assignment (result also cleared):
=== Memory Statistics ===
Total stored objects: 5
Total estimated size: 152 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
Expected: 0 lists

Test 22: Compare nil vs undefined - undefined preserves result
Before undefined assignment:
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 209 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
17    list      2         57
After undefined assignment (result preserved):
=== Memory Statistics ===
Total stored objects: 6
Total estimated size: 209 bytes

ID    Type      RefCount  Size(bytes)
----  --------  --------  -----------
1     list      1000000   24
2     channel   0         32
3     channel   0         32
4     channel   0         32
5     channel   0         32
17    list      1         57
Expected: 1 list with refcount=1 (only result)

=== Test Complete ===
