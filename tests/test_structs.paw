#!/usr/bin/env paw
# Test for StructDef and StoredStruct types

echo "=== Struct Tests ==="
echo ""

# Test 1: Create a struct definition
echo "Test 1: Create struct definition"
desc: {list ("name", 8, "bytes"), ("text", 32, "string"), ("age", 1, "int"), metaStuff: "Thing"}
#MyDef: {struct_def ~desc}
echo "Type of def: {type #MyDef}"
echo "(Expected: list)"
echo ""

# Test 2: Create a single struct
echo "Test 2: Create single struct"
myStruct: {struct #MyDef}
echo "Type of struct: {type myStruct}"
echo "(Expected: struct)"
echo ""

# Test 3: Access fields (should be zero-initialized)
echo "Test 3: Field access (zero-initialized)"
echo "name: {~myStruct.name}"
echo "age: {~myStruct.age}"
echo "(Expected: empty bytes, 0)"
echo ""

# Test 4: Create struct with source data
echo "Test 4: Create struct with source data"
sourceData: {list name: {bytes 0x4A, 0x6F, 0x68, 0x6E}, text: "Hello World", age: 25}
myStruct2: {struct #MyDef, ~sourceData}
echo "name bytes: {~myStruct2.name}"
echo "age: {~myStruct2.age}"
echo "(Expected: John bytes, 25)"
echo ""

# Test 5: Create struct array
echo "Test 5: Create struct array"
emptySource: {list}
myArray: {struct #MyDef, ~emptySource, 5}
echo "Type of array: {type myArray}"
echo "Length: {len ~myArray}"
echo "(Expected: structarray, 5)"
echo ""

# Test 6: Access struct array element
echo "Test 6: Access array element"
elem: {~myArray 0}
echo "Type of element: {type elem}"
echo "(Expected: struct)"
echo ""

# Test 7: Access field through array index
echo "Test 7: Access field through array index"
echo "First element age: {~myArray 0.age}"
echo "(Expected: 0)"
echo ""

# Test 8: Slice struct array
echo "Test 8: Slice struct array"
sliced: {slice ~myArray, 1, 3}
echo "Sliced length: {len ~sliced}"
echo "(Expected: 2)"
echo ""

# Test 9: Compact struct array
echo "Test 9: Compact struct array"
compacted: {compact ~sliced}
echo "Compacted length: {len ~compacted}"
echo "(Expected: 2)"
echo ""

# Test 10: Single struct len returns field count
echo "Test 10: Single struct len (field count)"
singleLen: {len ~myStruct}
echo "Field count: ~singleLen"
echo "(Expected: 3)"
echo ""

echo "=== All Struct Tests Complete ==="
