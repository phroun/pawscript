#!/usr/bin/env paw
# Comprehensive test for type command
# Tests type detection for variables containing all 9 types

echo "=== type Comprehensive Test ==="
echo ""

# Test 1: Integer variables
echo "Test 1: Integer variables"
int1: 42
type int1
echo "  int1 = 42 → {get_result} (expected: int)"

int2: -10
type int2
echo "  int2 = -10 → {get_result} (expected: int)"

int3: 0
type int3
echo "  int3 = 0 → {get_result} (expected: int)"
echo ""

# Test 2: Float variables
echo "Test 2: Float variables"
float1: 3.14
type float1
echo "  float1 = 3.14 → {get_result} (expected: float)"

float2: -0.5
type float2
echo "  float2 = -0.5 → {get_result} (expected: float)"

float3: 0.0
type float3
echo "  float3 = 0.0 → {get_result} (expected: float)"
echo ""

# Test 3: Boolean variables
echo "Test 3: Boolean variables"
bool1: true
type bool1
echo "  bool1 = true → {get_result} (expected: bool)"

bool2: false
type bool2
echo "  bool2 = false → {get_result} (expected: bool)"
echo ""

# Test 4: nil variables
echo "Test 4: nil variables"
null_var: nil
type null_var
echo "  null_var = nil → {get_result} (expected: nil)"
echo ""

# Test 5: String variables (quoted)
echo "Test 5: String variables (quoted)"
str1: "hello"
type str1
echo "  str1 = \"hello\" → {get_result} (expected: string)"

str2: "world"
type str2
echo "  str2 = \"world\" → {get_result} (expected: string)"

str3: ""
type str3
echo "  str3 = \"\" (empty) → {get_result} (expected: string)"

str4: "42"
type str4
echo "  str4 = \"42\" → {get_result} (expected: string)"
echo ""

# Test 6: Symbol variables (bare identifiers)
echo "Test 6: Symbol variables (bare identifiers)"
sym1: myvar
type sym1
echo "  sym1 = myvar → {get_result} (expected: symbol)"

sym2: identifier
type sym2
echo "  sym2 = identifier → {get_result} (expected: symbol)"

sym3: foo123
type sym3
echo "  sym3 = foo123 → {get_result} (expected: symbol)"

sym4: _underscore
type sym4
echo "  sym4 = _underscore → {get_result} (expected: symbol)"
echo ""

# Test 7: Block variables (ParenGroup)
echo "Test 7: Block variables (ParenGroup)"
block1: (echo test)
type block1
echo "  block1 = (echo test) → {get_result} (expected: block)"

block2: (code here)
type block2
echo "  block2 = (code here) → {get_result} (expected: block)"

block3: ()
type block3
echo "  block3 = () → {get_result} (expected: block)"
echo ""

# Test 8: Undefined variables
echo "Test 8: Undefined variables"
type nonexistent_var1
echo "  nonexistent_var1 → {get_result} (expected: undefined)"

type never_defined
echo "  never_defined → {get_result} (expected: undefined)"

type xyz123
echo "  xyz123 → {get_result} (expected: undefined)"
echo ""

# Test 9: Symbol vs String variables
echo "Test 9: Symbol vs String variables"
role_sym: admin
type role_sym
echo "  role_sym = admin → {get_result} (expected: symbol)"

role_str: "admin"
type role_str
echo "  role_str = \"admin\" → {get_result} (expected: string)"

status_sym: active
type status_sym
echo "  status_sym = active → {get_result} (expected: symbol)"

status_str: "active"
type status_str
echo "  status_str = \"active\" → {get_result} (expected: string)"
echo ""

# Test 10: Variable overwriting with different types
echo "Test 10: Variable type changes"
x: 42
type x
echo "  x = 42 → {get_result} (expected: int)"

x: "hello"
type x
echo "  x = \"hello\" → {get_result} (expected: string)"

x: myidentifier
type x
echo "  x = myidentifier → {get_result} (expected: symbol)"

x: true
type x
echo "  x = true → {get_result} (expected: bool)"

x: (code)
type x
echo "  x = (code) → {get_result} (expected: block)"
echo ""

# Test 11: Numbers in different forms
echo "Test 11: Numbers in different forms"
num_int: 123
type num_int
echo "  num_int = 123 → {get_result} (expected: int)"

num_str: "123"
type num_str
echo "  num_str = \"123\" → {get_result} (expected: string)"

num_float: 123.0
type num_float
echo "  num_float = 123.0 → {get_result} (expected: float)"
echo ""

# Test 12: Special string values
echo "Test 12: Special string values"
special1: "false"
type special1
echo "  special1 = \"false\" → {get_result} (expected: string)"

special2: "0"
type special2
echo "  special2 = \"0\" → {get_result} (expected: string)"

special3: "nil"
type special3
echo "  special3 = \"nil\" → {get_result} (expected: string)"

special4: "true"
type special4
echo "  special4 = \"true\" → {get_result} (expected: string)"
echo ""

# Test 13: Variable existence checking
echo "Test 13: Variable existence checking"

exists_var: test
if {eq {type exists_var}, undefined} then (
    echo "  ✗ FAIL: exists_var should exist"
) else (
    echo "  ✓ PASS: exists_var exists (type: {type exists_var})"
)

if {eq {type does_not_exist}, undefined} then (
    echo "  ✓ PASS: does_not_exist is undefined"
) else (
    echo "  ✗ FAIL: does_not_exist should be undefined"
)
echo ""

# Test 14: Case sensitivity
echo "Test 14: Case sensitivity"
MyVar: test1
myvar: test2
MYVAR: test3

type MyVar
echo "  MyVar → {get_result} (expected: symbol)"

type myvar
echo "  myvar → {get_result} (expected: symbol)"

type MYVAR
echo "  MYVAR → {get_result} (expected: symbol)"

type myVAR
echo "  myVAR (not defined) → {get_result} (expected: undefined)"
echo ""

#(
# Test 15: Practical use cases
echo "Test 15: Practical use cases"

# Safe variable access pattern
macro safe_access(
    if {eq {type $1}, undefined} then (
        echo "Variable $1 is not defined, using default"
        ret "default"
    ) else (
        echo "Variable $1 exists with type: {type $1}"
        true;ret ~$1
    )
)

echo "  Testing safe_access macro:"
echo "    Result for undefined_var: {safe_access undefined_var}"

my_value: actual
echo "    Result for my_value: {safe_access my_value}"
echo ""

# Type-based dispatch
macro type_dispatch(
    if {eq {type $1}, symbol} then (
        echo "Got symbol: ~$1"
    ) else if {eq {type $1}, string} then (
        echo "Got string: ~$1"
    ) else if {eq {type $1}, int} then (
        echo "Got int: ~$1"
    ) else if {eq {type $1}, undefined} then (
        echo "Variable $1 is undefined"
    ) else (
        echo "Got {type $1}: ~$1"
    )
)

test_sym: identifier
test_str: "text"
test_int: 42

echo "  Testing type_dispatch macro:"
echo "    "
type_dispatch test_sym
echo "    "
type_dispatch test_str
echo "    "
type_dispatch test_int
echo "    "
type_dispatch not_defined
echo ""
)#

# Test 15: List type
echo "Test 15: List type"
mylist: {list 1, 2, 3}
echo "  mylist type: {type mylist} (expected: list)"
emptylist: {list}
echo "  emptylist type: {type emptylist} (expected: list)"
echo ""

# Test 16: Bytes type
echo "Test 16: Bytes type"
mybytes: {bytes 0xDE, 0xAD, 0xBE, 0xEF}
echo "  mybytes type: {type mybytes} (expected: bytes)"
emptybytes: {bytes}
echo "  emptybytes type: {type emptybytes} (expected: bytes)"
echo ""

# Test 17: Struct types
echo "Test 17: Struct types"
# Create a struct definition (which is a list with __size)
structdesc: {list ("name", 8, "bytes"), ("age", 1, "int")}
#MyStructDef: {struct_def ~structdesc}
echo "  struct def type: {type #MyStructDef} (expected: list)"

# Create a single struct
singlestruct: {struct #MyStructDef}
echo "  single struct type: {type singlestruct} (expected: struct)"

# Create a struct array
structarray: {struct #MyStructDef, {list}, 3}
echo "  struct array type: {type structarray} (expected: structarray)"
echo ""

# Test 18: Channel type
echo "Test 18: Channel type"
mychan: {channel}
echo "  mychan type: {type mychan} (expected: channel)"
echo ""

# Test 19: File type (can't easily test without actual file operations)
echo "Test 19: File type"
echo "  (File type requires file operations - skipped)"
echo ""

# Test 20: Fiber type (requires spawn)
echo "Test 20: Fiber type"
echo "  (Fiber type requires spawn - skipped for basic test)"
echo ""

echo "=== Summary ==="
echo ""
echo "Expected behaviors:"
echo "  - Variables store their original type"
echo "  - Bare identifiers → symbol"
echo "  - Quoted text → string"
echo "  - Undefined variables → undefined"
echo "  - type always returns a type name (never fails)"
echo ""
echo "If all results match expected, type is working correctly!"
echo ""
echo "=== Test Complete ==="
